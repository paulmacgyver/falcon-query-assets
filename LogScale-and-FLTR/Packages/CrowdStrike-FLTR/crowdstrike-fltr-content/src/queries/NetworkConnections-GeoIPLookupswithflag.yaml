name: Network Connections - GeoIP Lookups with flag
visualization:
  options: {}
  type: table-view
$schema: https://schemas.humio.com/query/v0.1.0
timeInterval:
  isLive: false
  start: 1d
queryString: |+
  #event_simpleName = NetworkConnectIP4

  // Check the local address first.
  | case {
      // Apply when the LocalAddressIP4 is a non-RFC1918 IP address.
      !cidr(LocalAddressIP4, subnet=["224.0.0.0/4", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "169.254.0.0/16", "0.0.0.0/32"])
        | ipLocation(LocalAddressIP4)
        | match(file="geo_mapping.csv", column=CountryCode, field=LocalAddressIP4.country, include=["Country", "Continent", "Flag"], ignoreCase=true, strict=false);
      * | LocalAddressIP4.country:="PrivateIP" | Country:="PrivateIP" | Continent:="PrivateIP" | Flag:="NoFlag";
    }

  // Check the remote address.
  | case {
      // Apply when the dst_ip is a non-RFC1918 IP address.
      !cidr(RemoteAddressIP4, subnet=["224.0.0.0/4", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "169.254.0.0/16", "0.0.0.0/32"])
        | ipLocation(RemoteAddressIP4)
        | match(file="geo_mapping.csv", column=CountryCode, field=RemoteAddressIP4.country, include=["Country", "Continent", "Flag"], ignoreCase=true, strict=false);
      * | RemoteAddressIP4.country:="PrivateIP" | Country:="PrivateIP" | Continent:="PrivateIP" | Flag:="NoFlag";
    }

  // Add the ComputerName
  | $"crowdstrike/fltr-run:ComputerName"()

  // Format the output.
  | "Local IP":=rename(LocalAddressIP4)
  | "Remote IP":=rename(RemoteAddressIP4)

  // Example display of columns included in events, created as result of iplocation call, and fields added from lookup file match
  // Alternate example: | table([@timestamp, ComputerName, "Local IP", "Remote IP", "Country", "IOC"], limit=1000)
  | select([@timestamp, ComputerName, "Local IP", "Remote IP", Country, Continent, Flag])



